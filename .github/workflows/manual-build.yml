name: Manual Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'installer'
        type: choice
        options:
        - 'installer'
        - 'portable'
        - 'both'
      create_draft_release:
        description: 'Create draft release'
        required: false
        default: false
        type: boolean

jobs:
  manual-build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Inno Setup (if needed)
      if: ${{ github.event.inputs.build_type == 'installer' || github.event.inputs.build_type == 'both' }}
      run: |
        # Use chocolatey for more reliable installation
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        
        # Install Inno Setup via chocolatey
        choco install innosetup -y --timeout=300
        
        # Add to PATH
        $innoPath = "C:\Program Files (x86)\Inno Setup 6"
        if (Test-Path $innoPath) {
          echo $innoPath >> $env:GITHUB_PATH
          Write-Host "Inno Setup installed successfully"
        } else {
          throw "Inno Setup installation failed"
        }
      timeout-minutes: 10
        
    - name: Build with PyInstaller
      working-directory: build/Win
      run: |
        $process = Start-Process -FilePath "cmd.exe" -ArgumentList "/c", "build.bat" -PassThru -Wait -TimeoutSec 900
        if ($process.ExitCode -ne 0) {
          throw "Build script failed with exit code $($process.ExitCode)"
        }
      timeout-minutes: 15
        
    - name: Create installer
      if: ${{ github.event.inputs.build_type == 'installer' || github.event.inputs.build_type == 'both' }}
      working-directory: build/Win
      run: |
        $process = Start-Process -FilePath "iscc.exe" -ArgumentList "SWLegion_Setup.iss" -PassThru -Wait -TimeoutSec 300
        if ($process.ExitCode -ne 0) {
          throw "Inno Setup compilation failed"
        }
      timeout-minutes: 8
        
    - name: Create portable package
      if: ${{ github.event.inputs.build_type == 'portable' || github.event.inputs.build_type == 'both' }}
      working-directory: build/Win
      run: |
        .\create_portable_package.bat
        
    - name: Upload installer (if created)
      if: ${{ github.event.inputs.build_type == 'installer' || github.event.inputs.build_type == 'both' }}
      uses: actions/upload-artifact@v4
      with:
        name: SWLegion-Installer-Manual
        path: build/Win/InstallerSetup/SWLegion_Installer.exe
        
    - name: Upload portable package (if created)
      if: ${{ github.event.inputs.build_type == 'portable' || github.event.inputs.build_type == 'both' }}
      uses: actions/upload-artifact@v4
      with:
        name: SWLegion-Portable-Manual
        path: build/Win/SWLegion_Portable.zip
        
    - name: Create draft release
      if: ${{ github.event.inputs.create_draft_release == 'true' }}
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/Win/InstallerSetup/SWLegion_Installer.exe
          build/Win/SWLegion_Portable.zip
        name: Star Wars Legion Tool Suite (Manual Build)
        body: |
          ## Manual Build - Star Wars Legion Tool Suite
          
          This is a manual build created via GitHub Actions.
          
          ### ðŸ“¦ Download Options:
          - **SWLegion_Installer.exe**: Full Windows installer with setup wizard
          - **SWLegion_Portable.zip**: Portable version (extract and run)
          
          ### ðŸš€ Features:
          - Army Builder with visual marker system
          - Mission Builder and Battle Companion  
          - Custom Content Creator
          - Battlefield Map Creator
          
        tag_name: manual-build-${{ github.run_number }}
        draft: true
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}