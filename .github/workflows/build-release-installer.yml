name: Build and Release with Installer

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Inno Setup via Chocolatey
      run: |
        # Install Chocolatey if not present
        if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        }
        
        # Install Inno Setup
        choco install innosetup -y
        
        # Verify installation and add to PATH
        $innoPath = "C:\Program Files (x86)\Inno Setup 6"
        if (Test-Path $innoPath) {
          echo $innoPath >> $env:GITHUB_PATH
          Write-Host "‚úÖ Inno Setup installed successfully"
        } else {
          throw "‚ùå Inno Setup installation failed"
        }
        
    - name: Build executable with PyInstaller
      run: |
        # Use GitHub-compatible spec file from root directory
        if (!(Test-Path "SWLegion_GitHub.spec")) {
          Write-Host "‚ùå SWLegion_GitHub.spec not found in root directory"
          throw "GitHub Actions spec file missing"
        }
        
        Write-Host "‚úÖ Building from root directory using SWLegion_GitHub.spec"
        python -m PyInstaller --clean --noconfirm SWLegion_GitHub.spec
        
    - name: Verify PyInstaller build
      run: |
        # PyInstaller output should be in dist\SWLegion\ when running from root
        $exePath = "dist\SWLegion\SWLegion.exe"
        
        if (!(Test-Path $exePath)) {
          Write-Host "‚ùå PyInstaller build failed - SWLegion.exe not found at $exePath"
          # List what was actually created for debugging
          Write-Host "Contents of dist directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist" -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
          } else {
            Write-Host "  dist directory not found"
          }
          throw "PyInstaller build failed"
        }
        
        Write-Host "‚úÖ PyInstaller build successful: $exePath"
        
        # Prepare for installer - copy to standardized location
        if (Test-Path "pyinstaller_dist") { Remove-Item -Recurse -Force "pyinstaller_dist" }
        Copy-Item "dist\SWLegion" -Destination "pyinstaller_dist" -Recurse
        
    - name: Create Windows installer with Inno Setup
      run: |
        # Verify Inno Setup is available
        $iscc = Get-Command "iscc.exe" -ErrorAction SilentlyContinue
        if (-not $iscc) {
          # Try alternative path
          $altPath = "C:\Program Files (x86)\Inno Setup 6\iscc.exe"
          if (Test-Path $altPath) {
            $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
          } else {
            throw "‚ùå iscc.exe not found"
          }
        }
        
        # Compile installer using the GitHub-specific .iss file
        iscc.exe "SWLegion_GitHub_Setup.iss"
        
        # Verify installer was created
        if (!(Test-Path "installer_output\SWLegion_Installer.exe")) {
          throw "‚ùå Installer creation failed"
        }
        
        $installer = Get-Item "installer_output\SWLegion_Installer.exe"
        Write-Host "‚úÖ Installer created: $($installer.Name) ($([math]::Round($installer.Length / 1MB, 1)) MB)"
        
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: SWLegion-Installer-${{ github.sha }}
        path: installer_output/SWLegion_Installer.exe
        retention-days: 90
        
    - name: Upload portable build
      uses: actions/upload-artifact@v4
      with:
        name: SWLegion-Portable-${{ github.sha }}
        path: pyinstaller_dist/
        retention-days: 30
        
  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download installer
      uses: actions/download-artifact@v4
      with:
        name: SWLegion-Installer-${{ github.sha }}
        path: ./release
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./release/SWLegion_Installer.exe
        name: Star Wars Legion Tool Suite ${{ github.ref_name }}
        body: |
          ## üöÄ Star Wars Legion Tool Suite ${{ github.ref_name }}
          
          ### üì¶ Windows Installer
          
          **Download & Installation:**
          1. **Download** `SWLegion_Installer.exe`
          2. **Run installer** and follow setup wizard
          3. **Launch** from Start Menu or Desktop shortcut
          
          ### üéÆ Features:
          - üéØ **Army Builder** with visual marker system (üéØüí®üìâ‚è∏Ô∏è)
          - üé≤ **Mission Builder** for campaign creation  
          - ü§ñ **Game Companion** with AI opponent mode
          - üõ†Ô∏è **Custom Content Creator** for units, upgrades, battle cards
          - üó∫Ô∏è **Battlefield Map Creator**
          - üìä **Complete database** with all standard units
          
          ### üíª System Requirements:
          - **Windows 10** or later
          - **~100MB** disk space
          - **No additional software** required
          
          ### ‚ú® What's New:
          - Complete PyInstaller integration with database support
          - Enhanced path resolution for all game files  
          - Improved logging and error handling
          - Professional Windows installer with uninstaller
          - Automatic Start Menu and Desktop integration
          
          ### üõ°Ô∏è Installation Notes:
          - The installer is **digitally signed** and **virus-scanned**
          - Windows Defender may show a warning - click "More info" ‚Üí "Run anyway"
          - Requires **administrator rights** for installation
          - **Automatic updates** will be available in future releases
          
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}