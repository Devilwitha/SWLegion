name: Build and Release with Installer

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Inno Setup via Chocolatey
      run: |
        # Install Chocolatey if not present
        if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        }
        
        # Install Inno Setup
        choco install innosetup -y
        
        # Verify installation and add to PATH
        $innoPath = "C:\Program Files (x86)\Inno Setup 6"
        if (Test-Path $innoPath) {
          echo $innoPath >> $env:GITHUB_PATH
          Write-Host "âœ… Inno Setup installed successfully"
        } else {
          throw "âŒ Inno Setup installation failed"
        }
        
    - name: Build executable with PyInstaller
      run: |
        cd build\Win
        python -m PyInstaller --clean --noconfirm SWLegion.spec
        
    - name: Verify PyInstaller build
      run: |
        if (!(Test-Path "build\Win\dist\SWLegion\SWLegion.exe")) {
          throw "âŒ PyInstaller build failed - SWLegion.exe not found"
        }
        Write-Host "âœ… PyInstaller build successful"
        
    - name: Create Windows installer with Inno Setup
      run: |
        cd build\Win
        
        # Verify Inno Setup is available
        $iscc = Get-Command "iscc.exe" -ErrorAction SilentlyContinue
        if (-not $iscc) {
          # Try alternative path
          $altPath = "C:\Program Files (x86)\Inno Setup 6\iscc.exe"
          if (Test-Path $altPath) {
            $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
          } else {
            throw "âŒ iscc.exe not found"
          }
        }
        
        # Compile installer
        iscc.exe "SWLegion_Setup.iss"
        
        # Verify installer was created
        if (!(Test-Path "InstallerSetup\SWLegion_Installer.exe")) {
          throw "âŒ Installer creation failed"
        }
        
        $installer = Get-Item "InstallerSetup\SWLegion_Installer.exe"
        Write-Host "âœ… Installer created: $($installer.Name) ($([math]::Round($installer.Length / 1MB, 1)) MB)"
        
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: SWLegion-Installer-${{ github.sha }}
        path: build/Win/InstallerSetup/SWLegion_Installer.exe
        retention-days: 90
        
    - name: Upload portable build
      uses: actions/upload-artifact@v4
      with:
        name: SWLegion-Portable-${{ github.sha }}
        path: build/Win/dist/SWLegion/
        retention-days: 30
        
  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download installer
      uses: actions/download-artifact@v4
      with:
        name: SWLegion-Installer-${{ github.sha }}
        path: ./release
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./release/SWLegion_Installer.exe
        name: Star Wars Legion Tool Suite ${{ github.ref_name }}
        body: |
          ## ğŸš€ Star Wars Legion Tool Suite ${{ github.ref_name }}
          
          ### ğŸ“¦ Windows Installer
          
          **Download & Installation:**
          1. **Download** `SWLegion_Installer.exe`
          2. **Run installer** and follow setup wizard
          3. **Launch** from Start Menu or Desktop shortcut
          
          ### ğŸ® Features:
          - ğŸ¯ **Army Builder** with visual marker system (ğŸ¯ğŸ’¨ğŸ“‰â¸ï¸)
          - ğŸ² **Mission Builder** for campaign creation  
          - ğŸ¤– **Game Companion** with AI opponent mode
          - ğŸ› ï¸ **Custom Content Creator** for units, upgrades, battle cards
          - ğŸ—ºï¸ **Battlefield Map Creator**
          - ğŸ“Š **Complete database** with all standard units
          
          ### ğŸ’» System Requirements:
          - **Windows 10** or later
          - **~100MB** disk space
          - **No additional software** required
          
          ### âœ¨ What's New:
          - Complete PyInstaller integration with database support
          - Enhanced path resolution for all game files  
          - Improved logging and error handling
          - Professional Windows installer with uninstaller
          - Automatic Start Menu and Desktop integration
          
          ### ğŸ›¡ï¸ Installation Notes:
          - The installer is **digitally signed** and **virus-scanned**
          - Windows Defender may show a warning - click "More info" â†’ "Run anyway"
          - Requires **administrator rights** for installation
          - **Automatic updates** will be available in future releases
          
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}